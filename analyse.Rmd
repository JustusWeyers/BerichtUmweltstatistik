---
title: "Umweltstatistik Bericht - R"
author: "Justus Weyers"
date: "`r Sys.Date()`"
output: html_document
---

### Pakete laden

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(tmap)
library(glmulti)
library(car) # vif
library(corrplot)
library(GGally)
library(visreg)
library(Metrics)
```

# Einstellungen

```{r}
tmap::tmap_mode("view")
```

### Daten einlesen

```{r}
# Alles Einlesen
readin = read.table("Data/data.txt", header = TRUE)

# Verwendete Variablen auswÃ¤hlen
data = readin |> select(Punkt, Jahr, Stratum, x_UTM, y_UTM,
                        Tiefe_zum_Oxidationshorizont_cm, 
                        Maechtigkeit_Oxidationshorizont_cm, 
                        Maechtigkeit_A_Horizont_cm,
                        Maechtigkeit_AL_Schicht_cm,
                        Gelaendehoehe_m,
                        Bodenfeuchte_Prozent)

data_sf = st_as_sf(data, coords = c("x_UTM", "y_UTM"), crs = st_crs(25833))
tm_shape(data_sf) + tm_dots(col = "Bodenfeuchte_Prozent")

modeldata =  data |> select(Tiefe_zum_Oxidationshorizont_cm, 
                              Maechtigkeit_Oxidationshorizont_cm, 
                              Maechtigkeit_A_Horizont_cm,
                              Maechtigkeit_AL_Schicht_cm,
                              Gelaendehoehe_m,
                              Bodenfeuchte_Prozent)

head(modeldata)
```

# Einfaches lineares Modell

```{r}
linmodel = lm(Bodenfeuchte_Prozent ~ ., data = modeldata)
```

# 

```{r}
res = glmulti(linmodel, level = 1, method = "h",
              confsetsize = 8, crit = "AIC")
mean(res@crits)
plot(res, type = "s")

bestmodel = res@objects[[1]]

visreg(bestmodel)
```

```{r}
cor_model = cor(modeldata, use = "pairwise.complete.obs")
p_values = cor.mtest(modeldata, conf.level = 0.95)
corrplot(cor_model, p.mat = p_values$p, insig = 'p-value', sig.level = -1)
```


```{r}
vif(linmodel)
```

```{r}

```

# Predictions

```{r}
newdata = modeldata[,colnames(modeldata) != "Bodenfeuchte_Prozent"]
data$prediction = predict(bestmodel, newdata = newdata)
fehlerdf = data[!is.na(data$Bodenfeuchte_Prozent) & !is.na(data$prediction),]
rmse(actual = fehlerdf$Bodenfeuchte_Prozent, predicted = fehlerdf$prediction)

data$sqerr = (data$Bodenfeuchte_Prozent - data$prediction)^2

ggplot(data, aes(x = Bodenfeuchte_Prozent, y = prediction)) +
  geom_point(aes(col = as.factor(Stratum)))

ggplot(data, aes(x = as.factor(Stratum), y = sqerr, fill = as.factor(Stratum))) +
  geom_boxplot()
```

```{r}
data_sf$predictions = c(data$prediction)
tm_shape(data_sf) + tm_dots(col = "predictions")
```

